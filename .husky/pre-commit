#!/bin/sh
echo "ðŸ” Running comprehensive pre-commit checks..."

# Track start time
START_TIME=$(date +%s)

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo "${BLUE}==> $1${NC}"
}

print_success() {
    echo "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo "${RED}âŒ $1${NC}"
}

# Exit on any error
set -e

print_status "1. Security & Dependencies Audit"
echo "ðŸ”’ Checking for security vulnerabilities..."
if npm audit --audit-level=high --production; then
    print_success "No high-severity vulnerabilities found"
else
    print_error "Security vulnerabilities detected! Run 'npm audit fix'"
    exit 1
fi

print_status "2. Lint and Format Staged Files"
echo "ðŸ“ Formatting and linting staged files..."
npx lint-staged

print_status "3. TypeScript Type Checking"
echo "ðŸ” Running TypeScript type checking..."
npm run check

print_status "4. Build Verification"
echo "ðŸ—ï¸  Building project to ensure it compiles..."
npm run build

print_status "5. Test Suite"
echo "ðŸ§ª Running comprehensive test suite..."
npm test

print_status "6. Package Integrity"
echo "ðŸ“¦ Verifying package.json integrity..."
if npm ls --depth=0 > /dev/null 2>&1; then
    print_success "Package dependencies are consistent"
else
    print_warning "Package dependency issues detected"
fi

print_status "7. Git Hooks Validation"
echo "ðŸª Verifying Git hooks are properly configured..."
if [ -f .husky/commit-msg ] && [ -x .husky/commit-msg ]; then
    print_success "Commit message hooks configured"
else
    print_warning "Commit message validation not configured"
fi

# Check if GPG signing is configured
if git config --get commit.gpgsign > /dev/null 2>&1; then
    if [ "$(git config --get commit.gpgsign)" = "true" ]; then
        print_success "GPG commit signing is enabled"
    else
        print_warning "GPG commit signing is disabled"
    fi
else
    print_warning "GPG commit signing not configured"
fi

print_status "8. Documentation Checks"
echo "ðŸ“š Checking documentation consistency..."
if command -v markdownlint > /dev/null 2>&1; then
    npm run md:lint
    print_success "Documentation linting passed"
else
    print_warning "Markdownlint not available, skipping documentation checks"
fi

# Calculate execution time
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo ""
print_success "All pre-commit checks passed! âš¡ Completed in ${DURATION}s"
echo ""
echo "ðŸš€ Ready to commit with confidence!"
